# 使用指南

## 快速开始

### 1. 添加监控目标

1. 访问 http://localhost:8080
2. 点击顶部菜单"目标管理"
3. 点击"添加目标"按钮
4. 输入域名（如：example.com）和描述
5. 点击"确定"

### 2. 触发扫描

添加目标后，有两种方式触发扫描：

方式一：手动触发
- 在目标列表中点击"扫描"按钮

方式二：自动扫描
- 系统每 6 小时自动扫描所有启用的目标

### 3. 查看结果

扫描完成后，可以在以下页面查看结果：

- 仪表盘：查看总体统计信息
- 子域名：查看所有发现的子域名及其状态
- 变更中心：查看资产变更历史
- 任务列表：查看扫描任务执行情况

## 功能说明

### 仪表盘

显示系统总体运行情况：
- 监控目标数量
- 存活子域名数量
- 新增子域名数量
- 最近 7 天的变更数量

### 目标管理

管理监控目标：
- 添加新目标
- 编辑目标信息
- 启用/禁用目标
- 删除目标
- 手动触发扫描

### 子域名列表

查看所有发现的子域名：
- 子域名地址
- 状态（新增/存活/失效）
- HTTP 状态码
- 页面标题
- Web 服务器类型
- IP 地址
- 最后发现时间

支持按状态筛选：
- 新增：首次发现的子域名
- 存活：当前可访问的子域名
- 失效：超过 24 小时未响应的子域名

### 变更中心

以时间轴形式展示所有资产变更：
- 🆕 新增子域名：首次发现的子域名
- ✅ 子域名恢复：之前失效现在恢复的子域名
- ❌ 子域名失效：之前存活现在失效的子域名

### 任务列表

查看所有扫描任务的执行情况：
- 任务 ID
- 目标 ID
- 任务类型
- 执行状态
- 执行结果
- 错误信息
- 创建时间
- 完成时间

## 通知配置

### 企业微信机器人

1. 在企业微信群中添加机器人
2. 获取 Webhook URL
3. 编辑 `backend/config.yaml`：

```yaml
notification:
  wecom:
    enabled: true
    webhook: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
```

4. 重启服务：`docker-compose restart backend`

### 钉钉机器人

1. 在钉钉群中添加自定义机器人
2. 获取 Webhook URL 和密钥（如果启用了加签）
3. 编辑 `backend/config.yaml`：

```yaml
notification:
  dingtalk:
    enabled: true
    webhook: "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
    secret: "YOUR_SECRET"  # 如果启用了加签
```

4. 重启服务：`docker-compose restart backend`

## 通知内容

当发现资产变更时，系统会自动发送通知，包含：
- 目标域名
- 变更时间
- 新增子域名数量
- 恢复存活数量
- 失效子域名数量
- 前 10 条变更详情

示例通知：
```
🔍 资产变更通知

目标: example.com
时间: 2024-01-01 12:00:00

🆕 新增子域名: 3 个
✅ 恢复存活: 1 个

详细信息:
🆕 api.example.com (状态码: 200, 标题: API)
🆕 admin.example.com (状态码: 403, 标题: Forbidden)
🆕 test.example.com (状态码: 200, 标题: Test)
✅ old.example.com (状态码: 200, 标题: Old Site)
```

## 扫描流程

系统的扫描流程如下：

1. 子域名收集
   - 使用 Subfinder 收集子域名
   - 使用 Assetfinder 收集子域名
   - 查询 cert.sh 获取证书透明度日志
   - 合并去重

2. 存活验证
   - 使用 Httpx 批量验证子域名
   - 获取 HTTP 状态码、标题、服务器信息
   - 过滤出存活的子域名

3. 差量对比
   - 对比数据库中上次的扫描结果
   - 识别新增、恢复、失效的子域名
   - 生成变更日志

4. 发送通知
   - 如果有变更，发送通知到配置的渠道

## 最佳实践

### 1. 目标选择

- 添加你有权限测试的域名
- 建议从主域名开始，不要添加子域名
- 为每个目标添加清晰的描述

### 2. 扫描频率

- 默认 6 小时扫描一次
- 可以根据需求调整（config.yaml 中的 interval）
- 建议不要设置太频繁，避免被目标站点封禁

### 3. 结果分析

- 重点关注"变更中心"的新增子域名
- 新增的子域名可能是新上线的服务，值得深入测试
- 失效的子域名可能是服务下线或配置变更

### 4. 数据管理

- 定期备份数据库
- 清理不再需要的目标
- 导出重要的扫描结果

## 故障排查

### 扫描无结果

1. 检查目标域名是否正确
2. 查看任务列表中的错误信息
3. 检查后端日志：`docker-compose logs backend`
4. 确认服务器可以访问外网

### 通知未收到

1. 检查 Webhook URL 是否正确
2. 确认通知已启用（enabled: true）
3. 查看后端日志确认是否发送成功
4. 测试 Webhook 是否可用

### 服务无法访问

1. 检查 Docker 容器状态：`docker-compose ps`
2. 查看容器日志：`docker-compose logs`
3. 确认端口未被占用
4. 检查防火墙设置

## 安全建议

1. 修改默认数据库密码
2. 不要将系统暴露在公网
3. 定期更新 Docker 镜像
4. 只监控有权限测试的目标
5. 妥善保管通知 Webhook URL

## 性能优化

1. 根据服务器性能调整并发数
2. 使用 SSD 存储提升性能
3. 定期清理历史数据
4. 监控磁盘和内存使用情况
